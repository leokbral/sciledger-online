name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          
      - name: Install expect
        run: sudo apt-get install -y expect
          
      - name: Deploy to VM
        if: github.ref == 'refs/heads/main'
        env:
          HUNGRIA_PASSWORD: ${{ secrets.HUNGRIA_PASSWORD }}
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        run: |
          # Create expect script for automated SSH login
          cat > deploy.exp << 'EOL'
          #!/usr/bin/expect -f
          set timeout -1
          spawn ssh -p 4422 leonardocabral@177.20.147.141
          expect "password:"
          send "$env(HUNGRIA_PASSWORD)\r"
          expect "$ "
          send "ssh -p 4422 sciledger@10.7.40.192\r"
          expect "password:"
          send "$env(VM_PASSWORD)\r"
          expect "$ "
          send "cd /var/www/sciledger && git pull origin main && npm ci && npm run build && pm2 restart sciledger || pm2 start npm --name sciledger -- run preview\r"
          expect "$ "
          send "exit\r"
          expect "$ "
          send "exit\r"
          expect eof
          EOL
          
          chmod +x deploy.exp
          ./deploy.exp