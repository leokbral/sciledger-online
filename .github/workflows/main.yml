name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          
      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass expect
          
      - name: Deploy to VM
        if: github.ref == 'refs/heads/main'
        env:
          HUNGRIA_PASSWORD: ${{ secrets.HUNGRIA_PASSWORD }}
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        run: |
          # Create expect script for VM connection
          cat > vm_connect.exp << 'EOL'
          #!/usr/bin/expect -f
          set timeout -1
          set vm_pass [lindex $argv 0]
          
          # Connect to VM
          send "ssh -p 4422 sciledger@10.7.40.192\r"
          expect "password:"
          send "$vm_pass\r"
          expect "$ "
          
          # Run deployment commands
          send "cd /var/www/sciledger\r"
          expect "$ "
          send "git pull origin main\r"
          expect "$ "
          send "npm ci\r"
          expect "$ "
          send "npm run build\r"
          expect "$ "
          send "pm2 restart sciledger || pm2 start npm --name sciledger -- run preview\r"
          expect "$ "
          send "exit\r"
          expect eof
          EOL
          
          chmod +x vm_connect.exp
          
          # Connect to Hungria and run expect script
          sshpass -p "$HUNGRIA_PASSWORD" ssh -o StrictHostKeyChecking=no -p 4422 leonardocabral@177.20.147.141 "expect -f -" < vm_connect.exp "$VM_PASSWORD"