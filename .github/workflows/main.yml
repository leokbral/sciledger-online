name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          
      - name: Install sshpass
        run: sudo apt-get install sshpass -y
          
      - name: Deploy to VM
        if: github.ref == 'refs/heads/main'
        env:
          HUNGRIA_PASSWORD: ${{ secrets.HUNGRIA_PASSWORD }}
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        run: |
          # Create inner deployment script (to be executed on VM)
          echo '#!/bin/bash
          cd /var/www/sciledger && 
          git pull origin main && 
          npm ci && 
          npm run build && 
          pm2 restart sciledger || pm2 start npm --name sciledger -- run preview' > deploy_vm.sh
          
          # Create outer deployment script (to be executed on Hungria)
          echo '#!/bin/bash
          echo $1 | ssh -p 4422 sciledger@10.7.40.192 "bash -s"' > deploy_hungria.sh
          
          # Execute deployment through SSH chain
          sshpass -p "$HUNGRIA_PASSWORD" ssh -o StrictHostKeyChecking=no -p 4422 leonardocabral@177.20.147.141 \
            "bash -s '$VM_PASSWORD'" < deploy_hungria.sh < deploy_vm.sh